<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>局域网象棋游戏（C++实现，使用Socket，界面使用Win32，CodeBlocks+GCC编译） | maxuewei2</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">局域网象棋游戏（C++实现，使用Socket，界面使用Win32，CodeBlocks+GCC编译）</h1><a id="logo" href="/.">maxuewei2</a><p class="description">Xlc Love Coding</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/guestbook/"><i class="fa book"> 留言</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">局域网象棋游戏（C++实现，使用Socket，界面使用Win32，CodeBlocks+GCC编译）</h1><div class="post-meta">Mar 22, 2016<span> | </span><span class="category"><a href="/categories/学习/">学习</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><table>
<thead>
<tr>
<th>目录</th>
</tr>
</thead>
<tbody>
<tr>
<td>　　</td>
<td><a href="#chengguo">成果</a></td>
<td></td>
</tr>
<tr>
<td>　</td>
<td>　　　</td>
<td><a href="#xiaoguo">运行效果图</a></td>
</tr>
<tr>
<td>　　</td>
<td><a href="#guocheng">过程</a></td>
<td></td>
</tr>
<tr>
<td>　</td>
<td></td>
<td>　<a href="#liangduan">1. 首先的问题是下棋的两端应该是什么样的？</a></td>
</tr>
<tr>
<td></td>
<td></td>
<td>　　　　<a href="#cunchu">2. 接下来的问题是怎么表示，怎么存储？</a></td>
</tr>
<tr>
<td></td>
<td></td>
<td>　　<a href="#tongxin">3. 然后应该怎么通信呢？</a></td>
</tr>
<tr>
<td></td>
<td><a href="#daima">代码</a></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>　　　　<a href="#main">main.cpp</a></td>
</tr>
<tr>
<td></td>
<td></td>
<td>　　　　<a href="#chess">chinese_chess.h</a></td>
</tr>
<tr>
<td></td>
<td></td>
<td>　　　　<a href="#server">Server.h</a></td>
</tr>
<tr>
<td></td>
<td></td>
<td>　　　　<a href="#client">Client.h</a></td>
</tr>
<tr>
<td></td>
<td>　  <a href="#end">END</a></td>
<td></td>
</tr>
</tbody>
</table>
<p>&ensp;<br>&ensp;<br>&ensp;<br>&ensp;</p>
<p></p><h2 id="chengguo">成果</h2><p></p>
<h3 id="xiaoguo">运行效果图</h3>

<p>　　左边是在虚拟机里运行的，右边是在Host机上运行的。<br><img src="/imgs/xiangqi1.jpg" alt="chengguo"><br><img src="/imgs/xiangqi2.jpg" alt="chengguo"></p>
<p></p><h2 id="guocheng">过程</h2><br>　　记不起自己为什么要写这个象棋游戏的，大概是因为刚学了点儿Socket ，所以想用用，于是就写个局域网对战的象棋吧。。。<p></p>
<h3 id="liangduan">1.首先的问题是下棋的两端应该是什么样的？</h3>


<p>　　我希望下棋的两个人使用相同的程序。所以就不能像FTP一样，一个客户端，一个服务器端，而只能每个程序都是一样的，既是客户端（Client），又是服务器端（Server）。在通信时，己方的Client 向对方的Server 发送信息，对方的Client 向己方的Server 发送信息。两端都存储棋盘信息，通过通信保持棋盘信息的一致。</p>
<p>　　然后呢，应该是一端点击界面移子之后，应该能通知对方进行相同的移动。</p>
<p>　　综合以上两点，运行过程应该是这样的：</p>
<p>　　当在界面上点击棋子时，先判断当前是否轮到自己落子，如果是，则进行移动，更新界面，并通过Client 向对方Server 发送移动信息。对方Server 收到后，进行同样的移动，更新界面。</p>
<p>　　这里要求Server能随时接到对方发来的消息，所以Server的监听应该是一个额外的线程。</p>
<h3 id="cunchu">2.接下来的问题是怎么表示，怎么存储？</h3>

<p>　　棋盘，应该用二维数组存储比较好，数组坐标（以下所说的”数组坐标 “是指该二维数组中的一个(x,y)数对）对应棋盘坐标。那么数组里存储什么呢，一共有車、马、象、士、将、砲、卒七种棋子，那么设置一个棋子类作为基类，然后设置七个类继承棋子类？基类有一个move函数，每个子类重写该函数？但是移动似乎只是我程序的一小部分，这样似乎没必要。</p>
<p>　　那么存储整型数值？不同的数值代表不同的棋子？似乎可以。</p>
<p>　　那么就用7个数代替七种棋子，但是棋子有黑白色，要用一个数表示棋子类型（即是車、马或其他）和棋子颜色两个信息，那就用BLANK =8代表空子，黑方的車、马、象、士、将、砲、卒分别为1到7，白方的車、马、相、士、帅、炮、兵分别为9到15。</p>
<p>　　这样判断某数组坐标上棋子的颜色，就把其值与BLANK 比较，大于BLANK为白色，否则为黑色。</p>
<p>　　判断某数组坐标上棋子的类型，则将其值模BLANK 。</p>
<p>　　另外，因为下棋双方的视角是相反的，所以，棋盘在存储时应该是相反的，移动时的坐标也应该进行转换。</p>
<h3 id="tongxin">3.然后应该怎么通信呢？</h3><br>　　我希望这个程序打开后，就能找到对方，并确定谁是黑色，谁是白色。<br><br>　　也许可以让Client 在运行之后就对局域网进行端口扫描，然后给出正在运行此程序的IP 地址列表，让用户选择要连接到哪个，如果对方已经有了连接，则对方会拒绝此连接，如果对方没有连接，则对方程序会向对方用户提示该连接请求，如果，对方用户同意，则连接建立，否则依然是拒绝此连接。<br><br>　　但是，我没有采用以上所述方法（因为太复杂，我还是先做好主体工作吧=_=）。<br><br>　　所以在程序开始运行后，会让用户输入对方的IP 地址，然后Server 开始监听。之后Client 开始向对方发出连接请求。<br><br>　　Server 监听时，如果收到连接请求，就看对方的IP 地址是否是用户输入的IP 地址，如果不是，说明连接请求不是用户所希望的对方发送的，那就继续监听。<br><br>　　Client 请求连接时，如果对方同意了，就要开始确定自己的颜色了。<br><br>　　确定颜色这里困扰了我很久，最后采用的解决方法是这样的：<br>&gt;<br>　　　　核心思想就是谁先发出连接请求，谁就是黑色。<br>&gt;<br>　　　　也就是在Client 连接上对方之后，要判断Server 是不是已经连接了对方，如果Server 已连接，就说明是对方先发出的连接请求，那么对方就是黑色，自己就设为白色。如果Server 没有连接，就说明自己先连接上了对方，也就是自己是黑色。<br><br><br><br>　　以上就是编码前及编码时的大致想法。<br><br><br><h2 id="daima">代码</h2><br><h3 id="main">main.cpp</h3>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(UNICODE) &amp;&amp; !defined(_UNICODE)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> _UNICODE</span></div><div class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(_UNICODE) &amp;&amp; !defined(UNICODE)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> UNICODE</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tchar.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"chinese_chess.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Server.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Client.h"</span></span></div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> WIDTH 400       <span class="comment">//界面宽度</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> HEIGHT 400      <span class="comment">//界面高度</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ZERO_X 50       <span class="comment">//棋盘左边界</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ZERO_Y 50       <span class="comment">//棋盘上边界</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PIECE_BKCOLOR    RGB(175,143,89)   <span class="comment">//棋子背景色</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PIECE_WH 30        <span class="comment">//棋盘每个格子的宽度和高度</span></span></div><div class="line"></div><div class="line">HWND hwnd;               <span class="comment">/* This is the handle for our window */</span></div><div class="line"><span class="keyword">char</span>* ots_ip;           <span class="comment">//存储对方IP地址的字符串</span></div><div class="line"><span class="keyword">int</span> port;</div><div class="line"><span class="keyword">bool</span> is_connect_alive=<span class="literal">false</span>;        <span class="comment">//是否连接到对方</span></div><div class="line">Board * chess_board;          <span class="comment">//棋盘</span></div><div class="line">Server *server;</div><div class="line">Client *client;</div><div class="line"><span class="keyword">int</span> chess_sx=<span class="number">-1</span>;        <span class="comment">//移动起始位置的数组坐标</span></div><div class="line"><span class="keyword">int</span> chess_sy=<span class="number">-1</span>;</div><div class="line"><span class="keyword">int</span> chess_dx=<span class="number">-1</span>;        <span class="comment">//移动目标位置的数组坐标</span></div><div class="line"><span class="keyword">int</span> chess_dy=<span class="number">-1</span>;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/*  Declare Windows procedure  */</span></div><div class="line"><span class="function">LRESULT CALLBACK <span class="title">WindowProcedure</span> <span class="params">(HWND, UINT, WPARAM, LPARAM)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">/*  Make the class name into a global variable  */</span></div><div class="line">TCHAR szClassName[ ] = _T(<span class="string">"Chinese Chess"</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> WINAPI <span class="title">WinMain</span> <span class="params">(HINSTANCE hThisInstance,</span></span></div><div class="line">                    HINSTANCE hPrevInstance,</div><div class="line">                    LPSTR lpszArgument,</div><div class="line">                    <span class="keyword">int</span> nCmdShow) &#123;</div><div class="line">    MSG messages;            <span class="comment">/* Here messages to the application are saved */</span></div><div class="line">    WNDCLASSEX wincl;        <span class="comment">/* Data structure for the windowclass */</span></div><div class="line"></div><div class="line">    <span class="comment">/* The Window structure */</span></div><div class="line">    wincl.hInstance = hThisInstance;</div><div class="line">    wincl.lpszClassName = szClassName;</div><div class="line">    wincl.lpfnWndProc = WindowProcedure;      <span class="comment">/* This function is called by windows */</span></div><div class="line">    wincl.style = CS_DBLCLKS;                 <span class="comment">/* Catch double-clicks */</span></div><div class="line">    wincl.cbSize = <span class="keyword">sizeof</span> (WNDCLASSEX);</div><div class="line"></div><div class="line">    <span class="comment">/* Use default icon and mouse-pointer */</span></div><div class="line">    wincl.hIcon = LoadIcon (<span class="literal">NULL</span>, IDI_APPLICATION);</div><div class="line">    wincl.hIconSm = LoadIcon (<span class="literal">NULL</span>, IDI_APPLICATION);</div><div class="line">    wincl.hCursor = LoadCursor (<span class="literal">NULL</span>, IDC_ARROW);</div><div class="line">    wincl.lpszMenuName = <span class="literal">NULL</span>;                 <span class="comment">/* No menu */</span></div><div class="line">    wincl.cbClsExtra = <span class="number">0</span>;                      <span class="comment">/* No extra bytes after the window class */</span></div><div class="line">    wincl.cbWndExtra = <span class="number">0</span>;                      <span class="comment">/* structure or the window instance */</span></div><div class="line">    <span class="comment">/* Use Windows's default colour as the background of the window */</span></div><div class="line">    wincl.hbrBackground = (HBRUSH) COLOR_BACKGROUND;</div><div class="line"></div><div class="line">    <span class="comment">/* Register the window class, and if it fails quit the program */</span></div><div class="line">    <span class="keyword">if</span> (!RegisterClassEx (&amp;wincl))</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* The class is registered, let's create the program*/</span></div><div class="line">    hwnd = CreateWindowEx (</div><div class="line">               <span class="number">0</span>,                   <span class="comment">/* Extended possibilites for variation */</span></div><div class="line">               szClassName,         <span class="comment">/* Classname */</span></div><div class="line">               _T(<span class="string">"Chinese Chess"</span>),       <span class="comment">/* Title Text */</span></div><div class="line">               WS_OVERLAPPEDWINDOW, <span class="comment">/* default window */</span></div><div class="line">               CW_USEDEFAULT,       <span class="comment">/* Windows decides the position */</span></div><div class="line">               CW_USEDEFAULT,       <span class="comment">/* where the window ends up on the screen */</span></div><div class="line">               WIDTH,                 <span class="comment">/* The programs width */</span></div><div class="line">               HEIGHT,                 <span class="comment">/* and height in pixels */</span></div><div class="line">               HWND_DESKTOP,        <span class="comment">/* The window is a child-window to desktop */</span></div><div class="line">               <span class="literal">NULL</span>,                <span class="comment">/* No menu */</span></div><div class="line">               hThisInstance,       <span class="comment">/* Program Instance handler */</span></div><div class="line">               <span class="literal">NULL</span>                 <span class="comment">/* No Window Creation data */</span></div><div class="line">           );</div><div class="line"></div><div class="line">    <span class="comment">/* Make the window visible on the screen */</span></div><div class="line">    ShowWindow (hwnd, nCmdShow);</div><div class="line"></div><div class="line">    <span class="comment">/* Run the message loop. It will run until GetMessage() returns 0 */</span></div><div class="line">    <span class="keyword">while</span> (GetMessage (&amp;messages, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>)) &#123;</div><div class="line">        <span class="comment">/* Translate virtual-key messages into character messages */</span></div><div class="line">        TranslateMessage(&amp;messages);</div><div class="line">        <span class="comment">/* Send message to WindowProcedure */</span></div><div class="line">        DispatchMessage(&amp;messages);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/* The program return-value is 0 - The value that PostQuitMessage() gave */</span></div><div class="line">    <span class="keyword">return</span> messages.wParam;</div><div class="line">&#125;</div><div class="line"><span class="comment">//把数组坐标转换为界面坐标</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">xy_to_pixel</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y,<span class="keyword">int</span>*pixelx,<span class="keyword">int</span> *pixely)</span> </span>&#123;</div><div class="line">    *pixely=x*PIECE_WH+ZERO_Y;</div><div class="line">    *pixelx=y*PIECE_WH+ZERO_X;</div><div class="line">&#125;</div><div class="line"><span class="comment">//把界面坐标转换为数组坐标</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">pixel_to_xy</span><span class="params">(<span class="keyword">int</span> pixelx,<span class="keyword">int</span> pixely,<span class="keyword">int</span>*x,<span class="keyword">int</span> *y)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> r=PIECE_WH/<span class="number">2</span>;</div><div class="line">    *y=(pixelx-(ZERO_X-r))/PIECE_WH;</div><div class="line">    *x=(pixely-(ZERO_Y-r))/PIECE_WH;</div><div class="line">&#125;</div><div class="line"><span class="comment">//以数组坐标画线</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">draw_line</span><span class="params">(HDC hdc,<span class="keyword">int</span> sx,<span class="keyword">int</span> sy,<span class="keyword">int</span> dx,<span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> psx,psy,pdx,pdy;</div><div class="line">    xy_to_pixel(sx,sy,&amp;psx,&amp;psy);</div><div class="line">    xy_to_pixel(dx,dy,&amp;pdx,&amp;pdy);</div><div class="line">    MoveToEx (hdc, psx,psy, <span class="literal">NULL</span>) ;</div><div class="line">    LineTo (hdc, pdx, pdy) ;</div><div class="line">&#125;</div><div class="line"><span class="comment">//以数组坐标画棋子</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">paint_piece</span><span class="params">(HDC hdc,<span class="keyword">int</span> x,<span class="keyword">int</span> y,<span class="keyword">int</span> color,<span class="keyword">int</span> type)</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> HBRUSH  piece_brush =CreateSolidBrush (PIECE_BKCOLOR);    <span class="comment">//棋子的背景色</span></div><div class="line">    <span class="keyword">if</span>(type==<span class="number">0</span>||color==BLANK)<span class="keyword">return</span> ;</div><div class="line">    <span class="keyword">int</span> px,py;</div><div class="line">    xy_to_pixel(x,y,&amp;px,&amp;py);</div><div class="line">    <span class="keyword">int</span> r=PIECE_WH/<span class="number">2</span>;</div><div class="line">    SelectObject (hdc,piece_brush ) ;</div><div class="line">    Ellipse(hdc,px-r,py-r,px+r,py+r);</div><div class="line">    <span class="keyword">char</span> *text=<span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">5</span>];</div><div class="line">    <span class="keyword">switch</span>(type) &#123;</div><div class="line">    <span class="keyword">case</span> JU:</div><div class="line">        <span class="built_in">strcpy</span>(text,<span class="string">"車"</span>);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> MA:</div><div class="line">        <span class="built_in">strcpy</span>(text,<span class="string">"马"</span>);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> XIANG:</div><div class="line">        <span class="keyword">if</span>(color==BLACK)<span class="built_in">strcpy</span>(text,<span class="string">"象"</span>);</div><div class="line">        <span class="keyword">else</span> <span class="built_in">strcpy</span>(text,<span class="string">"相"</span>);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> SHI:</div><div class="line">        <span class="built_in">strcpy</span>(text,<span class="string">"士"</span>);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> JIANG:</div><div class="line">        <span class="keyword">if</span>(color==BLACK)<span class="built_in">strcpy</span>(text,<span class="string">"将"</span>);</div><div class="line">        <span class="keyword">else</span> <span class="built_in">strcpy</span>(text,<span class="string">"帅"</span>);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> PAO:</div><div class="line">        <span class="keyword">if</span>(color==BLACK)<span class="built_in">strcpy</span>(text,<span class="string">"砲"</span>);</div><div class="line">        <span class="keyword">else</span></div><div class="line">            <span class="built_in">strcpy</span>(text,<span class="string">"炮"</span>);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> ZU:</div><div class="line">        <span class="keyword">if</span>(color==BLACK)<span class="built_in">strcpy</span>(text,<span class="string">"卒"</span>);</div><div class="line">        <span class="keyword">else</span></div><div class="line">            <span class="built_in">strcpy</span>(text,<span class="string">"兵"</span>);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">        <span class="built_in">strcpy</span>(text,<span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line">    SetBkColor(hdc,PIECE_BKCOLOR);<span class="comment">//设置文字背景色</span></div><div class="line">    <span class="keyword">if</span>(color==BLACK) &#123;</div><div class="line">        SetTextColor(hdc,RGB(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>));       <span class="comment">//设置文字颜色</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        SetTextColor(hdc,RGB(<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>));</div><div class="line">    &#125;</div><div class="line">    TextOut (hdc, px-r/<span class="number">2</span>, py-r/<span class="number">2</span>,text , <span class="built_in">strlen</span>(<span class="string">"马"</span>)) ;</div><div class="line">    <span class="keyword">delete</span> text;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span>* <span class="title">main_listen</span><span class="params">(<span class="keyword">void</span> *)</span> </span>&#123;</div><div class="line">    server-&gt;listen_message();</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">//创建线程，使server开始监听</span></div><div class="line"><span class="function"><span class="keyword">bool</span>  <span class="title">start_listen</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">pthread_t</span> listen_p;</div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line">    ret= pthread_create( &amp;listen_p,  <span class="literal">NULL</span>, main_listen,<span class="literal">NULL</span> ); <span class="comment">//</span></div><div class="line">    <span class="keyword">if</span>( ret != <span class="number">0</span> ) &#123; <span class="comment">//创建线程成功返回0</span></div><div class="line">        <span class="comment">//printf("pthread_create error:error_code=%d\n",ret );</span></div><div class="line">        handle_error(THREAD_ERROR,<span class="literal">true</span>,<span class="literal">true</span>);</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span>* <span class="title">chess_connect</span><span class="params">(<span class="keyword">void</span> *)</span> </span>&#123;</div><div class="line">    server=<span class="keyword">new</span> Server();<span class="comment">//创建Server对象</span></div><div class="line">    client=<span class="keyword">new</span> Client(); <span class="comment">//创建Client对象，</span></div><div class="line">    start_listen();             <span class="comment">//创建线程，server开始监听</span></div><div class="line">    <span class="comment">//Sleep(100);</span></div><div class="line">    client-&gt;connect_to_ots();  <span class="comment">//client开始连接对方server，连接成功后返回</span></div><div class="line">    InvalidateRect(hwnd,<span class="literal">NULL</span>,<span class="literal">true</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">pthread_t</span> connect_p;</div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line">    ret= pthread_create( &amp;connect_p,  <span class="literal">NULL</span>, chess_connect,<span class="literal">NULL</span>); <span class="comment">//</span></div><div class="line">    <span class="keyword">if</span>( ret != <span class="number">0</span> ) &#123; <span class="comment">//创建线程成功返回0</span></div><div class="line">        <span class="comment">//printf("pthread_create error:error_code=%d\n",ret );</span></div><div class="line">        handle_error(THREAD_ERROR,<span class="literal">true</span>,<span class="literal">true</span>);</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/*  This function is called by the Windows function DispatchMessage()  */</span></div><div class="line"></div><div class="line"><span class="function">LRESULT CALLBACK <span class="title">WindowProcedure</span> <span class="params">(HWND hwnd, UINT message, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> POINT mouse;</div><div class="line">    <span class="keyword">static</span> HDC hdc;</div><div class="line">    <span class="keyword">static</span> PAINTSTRUCT ps ;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> iofip=<span class="number">0</span>;     <span class="comment">//index of ots_ip</span></div><div class="line">    <span class="keyword">switch</span> (message) &#123;                <span class="comment">/* handle the messages */</span></div><div class="line">    <span class="keyword">case</span> WM_CREATE: &#123;</div><div class="line">        port=<span class="number">35536</span>;</div><div class="line">        ots_ip=<span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">20</span>];</div><div class="line">        <span class="built_in">strcpy</span>(ots_ip,<span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> WM_KEYDOWN:<span class="comment">//识别按键，显示输入的内容（对方IP地址）</span></div><div class="line">        <span class="keyword">if</span>(wParam==<span class="number">13</span>) &#123;<span class="comment">//如果是ENTER，则初始化server、client，并开始连接，连接成功后初始化board</span></div><div class="line">            init();</div><div class="line">            Sleep(<span class="number">100</span>);</div><div class="line">            InvalidateRect(hwnd,<span class="literal">NULL</span>,<span class="literal">true</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(wParam==VK_BACK) &#123;<span class="comment">//删除键</span></div><div class="line">            <span class="keyword">if</span>(iofip==<span class="number">0</span>)<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">            iofip--;</div><div class="line">            ots_ip[iofip]=<span class="string">'\0'</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(wParam&lt;<span class="number">106</span>&amp;&amp;wParam&gt;<span class="number">95</span>) &#123;<span class="comment">//小键盘数字键</span></div><div class="line">            wParam-=<span class="number">48</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(wParam&lt;<span class="number">58</span>&amp;&amp;wParam&gt;<span class="number">47</span>) &#123;<span class="comment">//主键盘数字键</span></div><div class="line">            ots_ip[iofip]=<span class="string">'0'</span><span class="number">-48</span>+wParam;</div><div class="line">            iofip++;</div><div class="line">            ots_ip[iofip]=<span class="string">'\0'</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(wParam==<span class="number">110</span>||wParam==<span class="number">229</span>) &#123;<span class="comment">//小数点键，小键盘110，主键盘229</span></div><div class="line">            ots_ip[iofip]=<span class="string">'.'</span>;</div><div class="line">            iofip++;</div><div class="line">            ots_ip[iofip]=<span class="string">'\0'</span>;</div><div class="line">        &#125;</div><div class="line">        InvalidateRect(hwnd,<span class="literal">NULL</span>,<span class="literal">true</span>);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> WM_PAINT: &#123;</div><div class="line">        hdc=BeginPaint (hwnd,&amp;ps) ;</div><div class="line">        SetBkColor(hdc,RGB(<span class="number">200</span>,<span class="number">200</span>,<span class="number">200</span>));</div><div class="line">        <span class="keyword">if</span>(chess_board==<span class="literal">NULL</span>) &#123;<span class="comment">//显示输入的IP地址</span></div><div class="line">            <span class="keyword">char</span> tip[<span class="number">20</span>]=<span class="string">"请输入对方IP地址："</span>;</div><div class="line">            Rectangle(hdc,WIDTH/<span class="number">5</span><span class="number">-20</span>,HEIGHT/<span class="number">2</span><span class="number">-10</span>,WIDTH/<span class="number">5</span>*<span class="number">4</span>,HEIGHT/<span class="number">2</span>+<span class="number">20</span>);</div><div class="line">            TextOut(hdc,WIDTH/<span class="number">5</span>,HEIGHT/<span class="number">2</span><span class="number">-50</span>,tip,<span class="built_in">strlen</span>(tip));</div><div class="line">            TextOut(hdc,WIDTH/<span class="number">5</span>,HEIGHT/<span class="number">2</span>,ots_ip,<span class="built_in">strlen</span>(ots_ip));</div><div class="line">            <span class="keyword">if</span>(server!=<span class="literal">NULL</span>) &#123;             <span class="comment">//board==NULL而server!=NULL表示正在连接过程中</span></div><div class="line">                <span class="keyword">char</span> tip[<span class="number">20</span>]=<span class="string">"正在连接......"</span>;</div><div class="line">                TextOut(hdc,WIDTH/<span class="number">5</span>,HEIGHT/<span class="number">2</span>+<span class="number">50</span>,tip,<span class="built_in">strlen</span>(tip));</div><div class="line">            &#125;</div><div class="line">            EndPaint(hwnd,&amp;ps);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">char</span> text[<span class="number">10</span>]=<span class="string">"你的颜色:"</span>;</div><div class="line">        <span class="keyword">if</span>(chess_board-&gt;get_color()==BLACK) &#123;</div><div class="line">            <span class="built_in">strcat</span>(text,<span class="string">" 黑"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="built_in">strcat</span>(text,<span class="string">" 白"</span>);</div><div class="line">        &#125;</div><div class="line">        TextOut (hdc, <span class="number">0</span>, <span class="number">0</span>,text , <span class="built_in">strlen</span>(text)) ;</div><div class="line">        <span class="keyword">int</span> M=chess_board-&gt;get_M();</div><div class="line">        <span class="keyword">int</span> N=chess_board-&gt;get_N();</div><div class="line">        <span class="comment">//画棋盘</span></div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;M; i++) &#123;</div><div class="line">            draw_line(hdc,i,<span class="number">0</span>,i,N<span class="number">-1</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</div><div class="line">            draw_line(hdc,<span class="number">0</span>,i,N/<span class="number">2</span>,i);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</div><div class="line">            draw_line(hdc,N/<span class="number">2</span>+<span class="number">1</span>,i,N,i);</div><div class="line">        &#125;</div><div class="line">        draw_line(hdc,<span class="number">0</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">5</span>);</div><div class="line">        draw_line(hdc,<span class="number">0</span>,<span class="number">5</span>,<span class="number">2</span>,<span class="number">3</span>);</div><div class="line">        draw_line(hdc,<span class="number">9</span>,<span class="number">3</span>,<span class="number">7</span>,<span class="number">5</span>);</div><div class="line">        draw_line(hdc,<span class="number">7</span>,<span class="number">3</span>,<span class="number">9</span>,<span class="number">5</span>);</div><div class="line">        draw_line(hdc,<span class="number">4</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>);</div><div class="line">        draw_line(hdc,<span class="number">4</span>,<span class="number">8</span>,<span class="number">5</span>,<span class="number">8</span>);</div><div class="line">        <span class="comment">//画棋子</span></div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;M; i++) &#123;</div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;N; j++) &#123;</div><div class="line">                paint_piece(hdc,i,j,chess_board-&gt;get_color(i,j),chess_board-&gt;get_type(i,j));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        EndPaint(hwnd,&amp;ps);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> WM_LBUTTONUP: &#123;</div><div class="line">        <span class="keyword">if</span>(chess_board==<span class="literal">NULL</span>)<span class="keyword">break</span>;</div><div class="line">        <span class="keyword">if</span>(!chess_board-&gt;is_my_turn())<span class="keyword">break</span>;<span class="comment">//当前没轮到自己下棋</span></div><div class="line">        GetCursorPos(&amp;mouse);<span class="comment">//获取鼠标的屏幕坐标</span></div><div class="line">        ScreenToClient(hwnd,&amp;mouse);<span class="comment">//转换为界面坐标</span></div><div class="line">        <span class="keyword">int</span> x,y;</div><div class="line">        pixel_to_xy(mouse.x,mouse.y,&amp;x,&amp;y);<span class="comment">//转换为数组坐标</span></div><div class="line">        <span class="keyword">if</span>(chess_board-&gt;get_color(x,y)==chess_board-&gt;get_color()) &#123;<span class="comment">//点击的是自己的棋子</span></div><div class="line">            chess_sx=x;</div><div class="line">            chess_sy=y;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(chess_sx==<span class="number">-1</span>||chess_sy==<span class="number">-1</span>) &#123;<span class="comment">//起始坐标未赋值且点击的不是自己的棋子，则break</span></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        chess_dx=x;</div><div class="line">        chess_dy=y;</div><div class="line">        <span class="keyword">if</span>(chess_board-&gt;my_move_piece(chess_sx,chess_sy,chess_dx,chess_dy)) &#123; <span class="comment">//如果移动棋子合法</span></div><div class="line">            client-&gt;send_message(<span class="string">"move"</span>,chess_sx,chess_sy,chess_dx,chess_dy);   <span class="comment">//向对方发送移子信息</span></div><div class="line">            InvalidateRect(hwnd,<span class="literal">NULL</span>,<span class="literal">true</span>);</div><div class="line">            <span class="keyword">if</span>(chess_board-&gt;get_is_win()==WIN) &#123;</div><div class="line"></div><div class="line">                chess_board-&gt;init();<span class="comment">//重新初始化棋盘，重下一盘</span></div><div class="line">                MessageBox(hwnd,<span class="string">"你赢了"</span>,<span class="string">"获胜！"</span>,<span class="literal">NULL</span>);</div><div class="line">                InvalidateRect(hwnd,<span class="literal">NULL</span>,<span class="literal">true</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        chess_sx=<span class="number">-1</span>;</div><div class="line">        chess_sy=<span class="number">-1</span>;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">case</span> WM_DESTROY:</div><div class="line">        <span class="keyword">if</span>(server!=<span class="literal">NULL</span>)server-&gt;close();</div><div class="line">        <span class="keyword">if</span>(client!=<span class="literal">NULL</span>)client-&gt;close();</div><div class="line">        PostQuitMessage (<span class="number">0</span>);       <span class="comment">/* send a WM_QUIT to the message queue */</span></div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">default</span>:                      <span class="comment">/* for messages that we don't deal with */</span></div><div class="line">        <span class="keyword">return</span> DefWindowProc (hwnd, message, wParam, lParam);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="chess">chinese_chess.h</h3>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CHINESE_CHESS_H_INCLUDED</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> CHINESE_CHESS_H_INCLUDED</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> JU 1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MA 2</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> XIANG 3</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SHI 4</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> JIANG 5</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PAO 6</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ZU 7</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BLANK 8 <span class="comment">//空子</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BLACK -1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> WHITE 1</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> WIN 1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> LOSE -1</span></div><div class="line"><span class="keyword">class</span> Board &#123;</div><div class="line"><span class="keyword">private</span>:</div><div class="line">    <span class="keyword">bool</span> turn;   <span class="comment">//是否轮到自己下棋</span></div><div class="line">    <span class="keyword">int</span> color;  <span class="comment">//自己的颜色</span></div><div class="line">    <span class="keyword">int</span> M,N;        <span class="comment">//棋盘行数、列数</span></div><div class="line">    <span class="keyword">int</span> **b;    <span class="comment">//二维数组</span></div><div class="line">    <span class="keyword">int</span> is_win;     <span class="comment">//是否胜利</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">is_out</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span> </span>&#123;<span class="comment">//坐标是否出界</span></div><div class="line">        <span class="keyword">return</span> x&gt;M||y&gt;N||x&lt;<span class="number">0</span>||y&lt;<span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">is_same_color</span><span class="params">(<span class="keyword">int</span> sx,<span class="keyword">int</span> sy,<span class="keyword">int</span> dx,<span class="keyword">int</span> dy)</span> </span>&#123;<span class="comment">//源坐标与目的坐标是否是同一颜色</span></div><div class="line">        <span class="keyword">return</span> get_color(sx,sy)==get_color(dx,dy);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">swap_num</span><span class="params">(<span class="keyword">int</span> &amp; num1,<span class="keyword">int</span>&amp; num2)</span> </span>&#123;<span class="comment">//交换两个数</span></div><div class="line">        num1+=num2;</div><div class="line">        num2=num1-num2;</div><div class="line">        num1=num1-num2;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_abs</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;<span class="comment">//取得绝对值</span></div><div class="line">        <span class="keyword">return</span> num&gt;=<span class="number">0</span>?num:-num;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">num_of_not_blank_betweenn</span><span class="params">(<span class="keyword">int</span> sx,<span class="keyword">int</span> sy,<span class="keyword">int</span> dx,<span class="keyword">int</span> dy)</span> </span>&#123;<span class="comment">//返回在起始坐标和目的坐标之间棋子的个数</span></div><div class="line">        <span class="keyword">if</span>(!(sx==dx||sy==dy))<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">        <span class="keyword">int</span> num=<span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span>(sy&gt;dy)swap_num(sy,dy);</div><div class="line">        <span class="keyword">if</span>(sx&gt;dx)swap_num(sx,dx);</div><div class="line">        <span class="keyword">if</span>(sx==dx) &#123;</div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=sy+<span class="number">1</span>; i&lt;dy; i++) &#123;</div><div class="line">                <span class="keyword">if</span>(b[sx][i]!=BLANK)num++;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(sy==dy) &#123;</div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=sx+<span class="number">1</span>; i&lt;dx; i++) &#123;</div><div class="line">                <span class="keyword">if</span>(b[i][sy]!=BLANK)num++;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> num;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">is_correct_move_JU</span><span class="params">(<span class="keyword">int</span> sx,<span class="keyword">int</span> sy,<span class="keyword">int</span> dx,<span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> num_of_not_blank_betweenn(sx,sy,dx,dy)==<span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">is_correct_move_MA</span><span class="params">(<span class="keyword">int</span> sx,<span class="keyword">int</span> sy,<span class="keyword">int</span> dx,<span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> x=dx-sx,y=dy-sy;</div><div class="line">        <span class="keyword">if</span>(get_abs(x)==<span class="number">2</span>&amp;&amp;get_abs(y)==<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">if</span>(get_color(sx+x/<span class="number">2</span>,sy)==BLANK)<span class="keyword">return</span> <span class="literal">true</span>;<span class="comment">//硌马蹄检测</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(get_abs(x)==<span class="number">1</span>&amp;&amp;get_abs(y)==<span class="number">2</span>) &#123;</div><div class="line">            <span class="keyword">if</span>(get_color(sx,sy+y/<span class="number">2</span>)==BLANK)<span class="keyword">return</span> <span class="literal">true</span>;<span class="comment">//硌马蹄检测</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">is_correct_move_XIANG</span><span class="params">(<span class="keyword">int</span> sx,<span class="keyword">int</span> sy,<span class="keyword">int</span> dx,<span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> x=dx-sx,y=dy-sy;</div><div class="line">        <span class="keyword">if</span>(!(get_abs(x)==<span class="number">2</span>&amp;&amp;get_abs(y)==<span class="number">2</span>)) <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        <span class="keyword">if</span>(get_color(sx+x/<span class="number">2</span>,sy+y/<span class="number">2</span>)==BLANK)<span class="keyword">return</span> <span class="literal">true</span>;<span class="comment">//硌象蹄检测</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">is_correct_move_SHI</span><span class="params">(<span class="keyword">int</span> sx,<span class="keyword">int</span> sy,<span class="keyword">int</span> dx,<span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> x=dx-sx,y=dy-sy;</div><div class="line">        <span class="keyword">if</span>(!(get_abs(x)==<span class="number">1</span>&amp;&amp;get_abs(y)==<span class="number">1</span>)) <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        <span class="keyword">if</span>(dx&lt;<span class="number">7</span>)<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        <span class="keyword">if</span>(dy&lt;<span class="number">3</span>||dy&gt;<span class="number">5</span>)<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">is_correct_move_JIANG</span><span class="params">(<span class="keyword">int</span> sx,<span class="keyword">int</span> sy,<span class="keyword">int</span> dx,<span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> x=dx-sx,y=dy-sy;</div><div class="line">        <span class="keyword">if</span>(!((get_abs(x)==<span class="number">1</span>&amp;&amp;get_abs(y)==<span class="number">0</span>)||(get_abs(x)==<span class="number">0</span>&amp;&amp;get_abs(y)==<span class="number">1</span>))) <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        <span class="keyword">if</span>(dx&lt;<span class="number">7</span>)<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        <span class="keyword">if</span>(dy&lt;<span class="number">3</span>||dy&gt;<span class="number">5</span>)<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">3</span>; i++) &#123;<span class="comment">//明将检测</span></div><div class="line">            <span class="keyword">if</span>(get_type(i,dy)==JIANG) &#123;</div><div class="line">                <span class="keyword">if</span>(num_of_not_blank_betweenn(dx,dy,i,dy)==<span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">is_correct_move_PAO</span><span class="params">(<span class="keyword">int</span> sx,<span class="keyword">int</span> sy,<span class="keyword">int</span> dx,<span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> n=get_color(dx,dy)==BLANK?<span class="number">0</span>:<span class="number">1</span>;</div><div class="line">        <span class="keyword">return</span> num_of_not_blank_betweenn(sx,sy,dx,dy)==n;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">is_correct_move_ZU</span><span class="params">(<span class="keyword">int</span> sx,<span class="keyword">int</span> sy,<span class="keyword">int</span> dx,<span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(dx&gt;sx)<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        <span class="keyword">int</span> x=dx-sx,y=dy-sy;</div><div class="line">        <span class="keyword">if</span>(get_abs(x)+get_abs(y)!=<span class="number">1</span>)<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        <span class="keyword">if</span>(sx&gt;<span class="number">4</span>&amp;&amp;get_abs(x)!=<span class="number">1</span>)<span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">//过河前只能向前走</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">is_correct_move</span><span class="params">(<span class="keyword">int</span> sx,<span class="keyword">int</span> sy,<span class="keyword">int</span> dx,<span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(sx==dx&amp;&amp;sy==dy) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(is_out(sx,sy)||is_out(dx,dy)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(get_color(sx,sy)!=color) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(is_same_color(sx,sy,dx,dy)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">switch</span>(get_type(sx,sy)) &#123;</div><div class="line">        <span class="keyword">case</span> JU:</div><div class="line">            <span class="keyword">return</span> is_correct_move_JU(sx,sy,dx,dy);</div><div class="line">        <span class="keyword">case</span> MA:</div><div class="line">            <span class="keyword">return</span> is_correct_move_MA(sx,sy,dx,dy);</div><div class="line">        <span class="keyword">case</span> XIANG:</div><div class="line">            <span class="keyword">return</span> is_correct_move_XIANG(sx,sy,dx,dy);</div><div class="line">        <span class="keyword">case</span> SHI:</div><div class="line">            <span class="keyword">return</span> is_correct_move_SHI(sx,sy,dx,dy);</div><div class="line">        <span class="keyword">case</span> JIANG:</div><div class="line">            <span class="keyword">return</span> is_correct_move_JIANG(sx,sy,dx,dy);</div><div class="line">        <span class="keyword">case</span> PAO:</div><div class="line">            <span class="keyword">return</span> is_correct_move_PAO(sx,sy,dx,dy);</div><div class="line">        <span class="keyword">case</span> ZU:</div><div class="line">            <span class="keyword">return</span> is_correct_move_ZU(sx,sy,dx,dy);</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">move_s_to_d</span><span class="params">(<span class="keyword">int</span> sx,<span class="keyword">int</span> sy,<span class="keyword">int</span> dx,<span class="keyword">int</span> dy)</span> </span>&#123; <span class="comment">//移动操作</span></div><div class="line">        <span class="keyword">if</span>(get_type(dx,dy)==JIANG) &#123;    <span class="comment">//如果目的棋子是将</span></div><div class="line">            <span class="keyword">if</span>(get_color(dx,dy)==color)set_win(LOSE);<span class="comment">//如果是自己的将，则输</span></div><div class="line">            <span class="keyword">else</span> set_win(WIN);<span class="comment">//如果是对方的将，则赢</span></div><div class="line">        &#125;</div><div class="line">        b[dx][dy]=b[sx][sy];</div><div class="line">        b[sx][sy]=BLANK;</div><div class="line">        change_turn();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init_pieces</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;M; i+=M<span class="number">-1</span>) &#123;<span class="comment">//第一行和最后一行（即车马象士将士象马车）</span></div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> index=<span class="number">0</span>; index&lt;N; index++) &#123;</div><div class="line">                <span class="keyword">if</span>(index&lt;N/<span class="number">2</span>+<span class="number">1</span>)b[i][index]=index+<span class="number">1</span>;</div><div class="line">                <span class="keyword">else</span> b[i][index]=N-index;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//卒所在的行</span></div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> index=<span class="number">0</span>; index&lt;N; index+=<span class="number">2</span>) &#123;</div><div class="line">            b[<span class="number">3</span>][index]=ZU;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> index=<span class="number">0</span>; index&lt;N; index+=<span class="number">2</span>) &#123;</div><div class="line">            b[<span class="number">6</span>][index]=ZU;</div><div class="line">        &#125;</div><div class="line">        b[<span class="number">2</span>][<span class="number">1</span>]=PAO;</div><div class="line">        b[M<span class="number">-1</span><span class="number">-2</span>][<span class="number">1</span>]=PAO;</div><div class="line">        b[<span class="number">2</span>][N<span class="number">-1</span><span class="number">-1</span>]=PAO;</div><div class="line">        b[M<span class="number">-1</span><span class="number">-2</span>][N<span class="number">-1</span><span class="number">-1</span>]=PAO;</div><div class="line">        <span class="keyword">int</span> s,d;<span class="comment">//存储起始行和终点行</span></div><div class="line">        <span class="keyword">if</span>(color==BLACK) &#123;</div><div class="line">            s=<span class="number">0</span>;<span class="comment">//从0行到M/2行，即棋盘上半部分</span></div><div class="line">            d=M/<span class="number">2</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            s=M/<span class="number">2</span>;<span class="comment">//棋盘下半部分</span></div><div class="line">            d=M;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//从s行到d行，把非BLANK的值加BLANK，使小于BLANK的代表黑色棋，大于BLANK的代表白色棋</span></div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> index=s; index&lt;d; index++) &#123;</div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;N; j++) &#123;</div><div class="line">                <span class="keyword">if</span>(b[index][j]!=BLANK) &#123;</div><div class="line">                    b[index][j]+=BLANK;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    Board(<span class="keyword">int</span> c) &#123;</div><div class="line">        color=c;</div><div class="line">        M=<span class="number">10</span>;</div><div class="line">        N=<span class="number">9</span>;</div><div class="line">        b=<span class="keyword">new</span> <span class="keyword">int</span>*[M];</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;M; i++) &#123;</div><div class="line">            b[i]=<span class="keyword">new</span> <span class="keyword">int</span>[N];</div><div class="line">        &#125;</div><div class="line">        init();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;<span class="comment">//棋盘初始化</span></div><div class="line">        is_win=<span class="number">0</span>;</div><div class="line">        turn=color==BLACK?<span class="literal">true</span>:<span class="literal">false</span>;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;M; i++) &#123;</div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;N; j++) &#123;</div><div class="line">                b[i][j]=BLANK;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        init_pieces();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_M</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> M;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_N</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> N;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_color</span><span class="params">()</span> </span>&#123;<span class="comment">//获取己方的颜色</span></div><div class="line">        <span class="keyword">return</span> color;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_color</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span> </span>&#123;<span class="comment">//获取棋盘某一坐标上棋子的颜色</span></div><div class="line">        <span class="keyword">return</span> b[x][y]&gt;BLANK?WHITE:b[x][y]&lt;BLANK?BLACK:BLANK;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_type</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span> </span>&#123;<span class="comment">//获取棋子类型（空、车、马、象、士、将、炮、卒）</span></div><div class="line">        <span class="keyword">return</span> b[x][y]!=BLANK?b[x][y]%BLANK:BLANK;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set_win</span><span class="params">(<span class="keyword">int</span> is)</span> </span>&#123;</div><div class="line">        is_win=is;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_is_win</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> is_win;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">change_turn</span><span class="params">()</span> </span>&#123;</div><div class="line">        turn=turn==<span class="literal">true</span>?<span class="literal">false</span>:<span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">is_my_turn</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> turn;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">othside_move_piece</span><span class="params">(<span class="keyword">int</span> sx,<span class="keyword">int</span> sy,<span class="keyword">int</span> dx,<span class="keyword">int</span> dy)</span> </span>&#123;<span class="comment">//对方移子</span></div><div class="line">        sx=M<span class="number">-1</span>-sx;<span class="comment">//先进行坐标转换，因对方视角与己方相反</span></div><div class="line">        sy=N<span class="number">-1</span>-sy;</div><div class="line">        dx=M<span class="number">-1</span>-dx;</div><div class="line">        dy=N<span class="number">-1</span>-dy;</div><div class="line">        move_s_to_d(sx,sy,dx,dy);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">my_move_piece</span><span class="params">(<span class="keyword">int</span> sx,<span class="keyword">int</span> sy,<span class="keyword">int</span> dx,<span class="keyword">int</span> dy)</span> </span>&#123;       <span class="comment">//己方主动移子</span></div><div class="line">        <span class="keyword">if</span>(!is_correct_move(sx,sy,dx,dy))<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        move_s_to_d(sx,sy,dx,dy);</div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// CHINESE_CHESS_H_INCLUDED</span></span></div></pre></td></tr></table></figure>
<h3 id="server">Server.h</h3>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> SERVER_H_INCLUDED</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SERVER_H_INCLUDED</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winsock2.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">"chinese_chess.h"</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> INIT_ERROR 1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BIND_ERROR 2</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> LISTEN_ERROR 3</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> CONNECT_ERROR 4</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SEND_ERROR 5</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ACCEPT_ERROR 6</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ALIVE_ERROR 7</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> THREAD_ERROR 8</span></div><div class="line"><span class="keyword">int</span> error_num;</div><div class="line"><span class="keyword">extern</span> HWND hwnd;</div><div class="line"><span class="keyword">extern</span> Board* chess_board;</div><div class="line"><span class="keyword">extern</span> <span class="keyword">char</span>* ots_ip;</div><div class="line"><span class="keyword">extern</span> <span class="keyword">int</span> port;</div><div class="line"><span class="keyword">extern</span> <span class="keyword">bool</span> is_connect_alive;</div><div class="line"></div><div class="line"><span class="comment">//线程参数结构体</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> server_args &#123;</div><div class="line">    SOCKET* Com_Sock;</div><div class="line">    <span class="keyword">char</span> * rebuf;</div><div class="line">&#125; server_args;</div><div class="line"><span class="comment">//校验检测，与客户端的添加校验是相反操作</span></div><div class="line"><span class="comment">//最后一位之前的所有字符相加取模后，如果等于最后一个字符，则校验通过</span></div><div class="line"><span class="function"><span class="keyword">bool</span> <span class="title">server_check</span><span class="params">(<span class="keyword">char</span> * r)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> len=<span class="built_in">strlen</span>(r);</div><div class="line">    len--;</div><div class="line">    <span class="keyword">int</span> s=<span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;len; i++) &#123;</div><div class="line">        s+=r[i];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(r[len]==(s%<span class="number">5</span>+<span class="string">'0'</span>)) &#123;</div><div class="line">        r[len]=<span class="string">'\0'</span>;</div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">//错误处理，is_tell控制是否显示错误信息，is_exit控制是否退出程序</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">handle_error</span><span class="params">(<span class="keyword">int</span> err,<span class="keyword">bool</span> is_tell,<span class="keyword">bool</span> is_exit)</span> </span>&#123;</div><div class="line">    error_num=err;</div><div class="line">    <span class="keyword">if</span>(!is_tell)<span class="keyword">return</span> error_num;</div><div class="line">    <span class="keyword">char</span> error[<span class="number">30</span>]=<span class="string">""</span>;</div><div class="line">    <span class="keyword">switch</span>(error_num) &#123;</div><div class="line">    <span class="keyword">case</span> INIT_ERROR:</div><div class="line">        <span class="built_in">strcpy</span>(error,<span class="string">"初始化错误"</span>);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> BIND_ERROR:</div><div class="line">        <span class="built_in">strcpy</span>(error,<span class="string">"绑定端口错误"</span>);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> LISTEN_ERROR:</div><div class="line">        <span class="built_in">strcpy</span>(error,<span class="string">"监听错误"</span>);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> ACCEPT_ERROR:</div><div class="line">        <span class="built_in">strcpy</span>(error,<span class="string">"接受连接错误"</span>);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> CONNECT_ERROR:</div><div class="line">        <span class="built_in">strcpy</span>(error,<span class="string">"无法连接"</span>);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> ALIVE_ERROR:</div><div class="line">        <span class="built_in">strcpy</span>(error,<span class="string">"连接已断开"</span>);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> THREAD_ERROR:</div><div class="line">        <span class="built_in">strcpy</span>(error,<span class="string">"线程无法创建"</span>);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> SEND_ERROR:</div><div class="line">        <span class="built_in">strcpy</span>(error,<span class="string">"发送错误"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">char</span> error_message[<span class="number">50</span>];</div><div class="line">    <span class="built_in">strcpy</span>(error_message,<span class="string">"错误："</span>);</div><div class="line">    <span class="built_in">strcat</span>(error_message,error);</div><div class="line">    <span class="keyword">if</span>(is_exit)<span class="built_in">strcat</span>(error_message,<span class="string">"\n程序将退出。"</span>);</div><div class="line">    MessageBox(hwnd,error_message,<span class="string">"错误"</span>,MB_OK);</div><div class="line">    <span class="keyword">if</span>(is_exit)<span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line">    <span class="keyword">return</span> error_num;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span>* <span class="title">handle_message</span><span class="params">(<span class="keyword">void</span>*ar)</span> </span>&#123;</div><div class="line">    server_args * serarg=(server_args * )ar;</div><div class="line">    <span class="keyword">char</span> *recv=serarg-&gt;rebuf;</div><div class="line">    SOCKET* CommandSock=serarg-&gt;Com_Sock;</div><div class="line">    <span class="keyword">if</span>(server_check(recv)) &#123;<span class="comment">//校验通过发送okok（OK），不通过发送noto（NOTOK）</span></div><div class="line">        send(*CommandSock,<span class="string">"okok"</span>,<span class="number">4</span>,<span class="number">0</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        send(*CommandSock,<span class="string">"noto"</span>,<span class="number">4</span>,<span class="number">0</span>);</div><div class="line">        <span class="keyword">return</span> ar;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(<span class="built_in">strncmp</span>(recv,<span class="string">"move"</span>,<span class="number">4</span>)==<span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">char</span> * pch;</div><div class="line">        <span class="comment">//将recvBuf以逗号拆分</span></div><div class="line">        pch = strtok (recv,<span class="string">","</span>);</div><div class="line">        pch = strtok (<span class="literal">NULL</span>,<span class="string">","</span>);</div><div class="line">        <span class="keyword">int</span> xys[<span class="number">4</span>];</div><div class="line">        <span class="keyword">int</span> index=<span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span> (pch != <span class="literal">NULL</span>) &#123;</div><div class="line">            xys[index]=atoi(pch);<span class="comment">//char* 转换为int</span></div><div class="line">            index++;</div><div class="line">            pch = strtok (<span class="literal">NULL</span>, <span class="string">","</span>);</div><div class="line">        &#125;</div><div class="line">        chess_board-&gt;othside_move_piece(xys[<span class="number">0</span>],xys[<span class="number">1</span>],xys[<span class="number">2</span>],xys[<span class="number">3</span>]);</div><div class="line">        <span class="keyword">if</span>(chess_board-&gt;get_is_win()==LOSE) &#123;</div><div class="line">            chess_board-&gt;init();<span class="comment">//如果输了，则重新初始化棋盘，再下一盘</span></div><div class="line">            MessageBox(hwnd,<span class="string">"你输了"</span>,<span class="string">"失败！"</span>,<span class="literal">NULL</span>);</div><div class="line">        &#125;</div><div class="line">        InvalidateRect(hwnd,<span class="literal">NULL</span>,<span class="literal">true</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">delete</span> recv;</div><div class="line">&#125;</div><div class="line"><span class="keyword">class</span> Server &#123;</div><div class="line"><span class="keyword">private</span>:</div><div class="line">    SOCKET Server_Sock;</div><div class="line">    SOCKADDR_IN server_addr;</div><div class="line">    SOCKADDR_IN client_addr;</div><div class="line">    <span class="keyword">char</span> recvBuf[<span class="number">20</span>];</div><div class="line"></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    Server() &#123;</div><div class="line">        WSADATA wsa;</div><div class="line">        <span class="comment">/*初始化socket资源*/</span></div><div class="line">        <span class="keyword">if</span> (WSAStartup(MAKEWORD(<span class="number">1</span>,<span class="number">1</span>),&amp;wsa) != <span class="number">0</span>) &#123;</div><div class="line">            handle_error(INIT_ERROR,<span class="literal">true</span>,<span class="literal">true</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span>((Server_Sock = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>))==<span class="number">-1</span>) &#123;</div><div class="line">            handle_error(INIT_ERROR,<span class="literal">true</span>,<span class="literal">true</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        ZeroMemory((<span class="keyword">char</span> *)&amp;server_addr,<span class="keyword">sizeof</span>(server_addr));</div><div class="line">        server_addr.sin_family = AF_INET;</div><div class="line">        server_addr.sin_port = htons(port);           <span class="comment">/*本地监听端口*/</span></div><div class="line">        server_addr.sin_addr.s_addr = htonl(INADDR_ANY); <span class="comment">/*有IP*/</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span>(bind(Server_Sock,(<span class="keyword">struct</span> sockaddr *)&amp;server_addr,<span class="keyword">sizeof</span>(server_addr))==<span class="number">-1</span>) &#123;</div><div class="line">            handle_error(BIND_ERROR,<span class="literal">true</span>,<span class="literal">true</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(listen(Server_Sock,<span class="number">5</span>)==<span class="number">-1</span>) &#123; <span class="comment">//其中第二个参数代表能够接收的最多的连接数</span></div><div class="line">            handle_error(LISTEN_ERROR,<span class="literal">true</span>,<span class="literal">true</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">strcpy</span>(recvBuf,<span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">listen_message</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> len=<span class="keyword">sizeof</span>(SOCKADDR);</div><div class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</div><div class="line">            SOCKET Command_Sock  = accept(Server_Sock, (SOCKADDR*)&amp;client_addr,&amp;len);</div><div class="line">            <span class="keyword">if</span>(Command_Sock == INVALID_SOCKET) &#123;</div><div class="line">                closesocket(Command_Sock);</div><div class="line">                handle_error(ACCEPT_ERROR,<span class="literal">false</span>,<span class="literal">false</span>);</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(client_addr.sin_addr.s_addr!=inet_addr(ots_ip)) &#123;<span class="comment">//如果接收的socket不是预期的对方的，则发送wron，继续等待</span></div><div class="line">                send(Command_Sock,<span class="string">"wron"</span>,<span class="number">4</span>,<span class="number">0</span>);</div><div class="line">                closesocket(Command_Sock);</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            send(Command_Sock,<span class="string">"righ"</span>,<span class="number">4</span>,<span class="number">0</span>);</div><div class="line">            is_connect_alive=<span class="literal">true</span>;</div><div class="line">            <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</div><div class="line">                <span class="keyword">if</span>(recv(Command_Sock,recvBuf,<span class="number">20</span>,<span class="number">0</span>)&lt;=<span class="number">0</span>) &#123;<span class="comment">//recv返回小于等于0的值，则连接已断开</span></div><div class="line">                    handle_error(ALIVE_ERROR,<span class="literal">true</span>,<span class="literal">true</span>);</div><div class="line">                    closesocket(Command_Sock);</div><div class="line">                    close();</div><div class="line">                    <span class="keyword">return</span> ;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">char</span> *rbuf=<span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">20</span>];</div><div class="line">                <span class="built_in">strcpy</span>(rbuf,recvBuf);</div><div class="line">                server_args serarg;</div><div class="line">                serarg.Com_Sock=&amp;Command_Sock;</div><div class="line">                serarg.rebuf=rbuf;</div><div class="line">                <span class="keyword">pthread_t</span> handle_m;</div><div class="line">                <span class="keyword">int</span> ret;</div><div class="line">                ret= pthread_create( &amp;handle_m,  <span class="literal">NULL</span>, handle_message,&amp;serarg); <span class="comment">//</span></div><div class="line">                <span class="keyword">if</span>( ret != <span class="number">0</span> ) &#123; <span class="comment">//创建线程成功返回0</span></div><div class="line">                    <span class="comment">// printf("pthread_create error:error_code=%d\n",ret );</span></div><div class="line">                    handle_error(THREAD_ERROR,<span class="literal">true</span>,<span class="literal">true</span>);</div><div class="line">                    <span class="keyword">return</span> ;</div><div class="line">                &#125;</div><div class="line">                <span class="built_in">strcpy</span>(recvBuf,<span class="string">""</span>);</div><div class="line">            &#125;</div><div class="line">            closesocket(Command_Sock);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</div><div class="line">        closesocket(Server_Sock);</div><div class="line">        WSACleanup();</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// SERVER_H_INCLUDED</span></span></div></pre></td></tr></table></figure>
<h3 id="client">Client.h</h3>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CLIENT_H_INCLUDED</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> CLIENT_H_INCLUDED</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winsock2.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">"chinese_chess.h"</span></span></div><div class="line"></div><div class="line"><span class="comment">//为字符串添加校验信息，对所有字符求和，模5之后转化为字符放在字符串最后</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">client_check</span><span class="params">(<span class="keyword">char</span>* r)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> len=<span class="built_in">strlen</span>(r);</div><div class="line">    <span class="keyword">int</span> s=<span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;len; i++) &#123;</div><div class="line">        s+=r[i];</div><div class="line">    &#125;</div><div class="line">    r[len]=s%<span class="number">5</span>+<span class="string">'0'</span>;</div><div class="line">    r[len+<span class="number">1</span>]=<span class="string">'\0'</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">class</span> Client &#123;</div><div class="line"><span class="keyword">private</span>:</div><div class="line">    SOCKET Client_Sock;</div><div class="line">    SOCKADDR_IN server_addr;</div><div class="line">    <span class="keyword">char</span> sendBuf[<span class="number">20</span>];</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    Client() &#123;</div><div class="line">        WSADATA wsa;</div><div class="line">        <span class="comment">/*初始化socket资源*/</span></div><div class="line">        <span class="keyword">if</span> (WSAStartup(MAKEWORD(<span class="number">1</span>,<span class="number">1</span>),&amp;wsa) != <span class="number">0</span>) &#123;</div><div class="line">            handle_error(INIT_ERROR,<span class="literal">true</span>,<span class="literal">true</span>);</div><div class="line">            <span class="keyword">return</span>;   <span class="comment">//代表失败</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>((Client_Sock = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>))==<span class="number">-1</span>) &#123;</div><div class="line">            handle_error(INIT_ERROR,<span class="literal">true</span>,<span class="literal">true</span>);</div><div class="line">            <span class="keyword">return</span>;   <span class="comment">//代表失败</span></div><div class="line">        &#125;</div><div class="line">        server_addr.sin_addr.S_un.S_addr=inet_addr(ots_ip);</div><div class="line">        server_addr.sin_family=AF_INET;</div><div class="line">        server_addr.sin_port=htons(port);</div><div class="line">        <span class="built_in">strcpy</span>(sendBuf,<span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">connect_to_ots</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">while</span>(connect(Client_Sock,(SOCKADDR*)&amp;server_addr,<span class="keyword">sizeof</span>(SOCKADDR)) ==<span class="number">-1</span>) &#123;</div><div class="line">            handle_error(CONNECT_ERROR,<span class="literal">false</span>,<span class="literal">false</span>);</div><div class="line">            Sleep(<span class="number">100</span>);</div><div class="line">            <span class="comment">//printf( "%d ", WSAGetLastError());</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">char</span> rec[<span class="number">5</span>];</div><div class="line">        recv(Client_Sock,rec,<span class="number">4</span>,<span class="number">0</span>);</div><div class="line">        <span class="keyword">if</span>(<span class="built_in">strncmp</span>(rec,<span class="string">"wron"</span>,<span class="number">4</span>)==<span class="number">0</span>) &#123;  <span class="comment">//收到wrong，说明对方所输入的IP不是己方IP</span></div><div class="line">            MessageBox(hwnd,<span class="string">"对方输入的IP不是你\n程序将退出"</span>,<span class="string">"错误"</span>,<span class="literal">NULL</span>);</div><div class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//谁先连接谁是黑色</span></div><div class="line">        <span class="comment">//如果server已经收到连接，则说明是对方先连接自己，则自己应为白色，否则自己是黑色</span></div><div class="line">        <span class="keyword">if</span>(is_connect_alive) &#123;</div><div class="line">            chess_board=<span class="keyword">new</span> Board(WHITE);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            chess_board=<span class="keyword">new</span> Board(BLACK);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</div><div class="line">        closesocket(Client_Sock);</div><div class="line">        WSACleanup();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">send_message</span><span class="params">(<span class="keyword">char</span> * message)</span> </span>&#123;</div><div class="line">        <span class="built_in">strcpy</span>(sendBuf,message);</div><div class="line">        client_check(sendBuf);</div><div class="line">        <span class="keyword">int</span> len;</div><div class="line">        <span class="keyword">int</span> try_time=<span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</div><div class="line">            len=send(Client_Sock,sendBuf,<span class="built_in">strlen</span>(sendBuf)+<span class="number">1</span>,<span class="number">0</span>);</div><div class="line">            <span class="keyword">if</span>(len!=(<span class="built_in">strlen</span>(sendBuf)+<span class="number">1</span>)) &#123;</div><div class="line">                handle_error(SEND_ERROR,<span class="literal">false</span>,<span class="literal">false</span>);</div><div class="line">                <span class="comment">//printf( "%d ", WSAGetLastError());</span></div><div class="line">            &#125;</div><div class="line">            <span class="keyword">char</span> rec[<span class="number">5</span>];</div><div class="line">            recv(Client_Sock,rec,<span class="number">4</span>,<span class="number">0</span>);</div><div class="line">            <span class="keyword">if</span>(<span class="built_in">strncmp</span>(rec,<span class="string">"okok"</span>,<span class="number">4</span>)==<span class="number">0</span>) &#123;<span class="comment">//收到OK说明数据已经正确被对方收到</span></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(try_time&gt;<span class="number">20</span>) &#123;   <span class="comment">//尝试20次，数据仍无法正确送达，则退出</span></div><div class="line">                handle_error(SEND_ERROR,<span class="literal">true</span>,<span class="literal">true</span>);</div><div class="line">            &#125;</div><div class="line">            try_time++;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> len;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">send_message</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> * message,<span class="keyword">int</span> sx,<span class="keyword">int</span> sy,<span class="keyword">int</span> dx,<span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line">        <span class="keyword">char</span>* message_temp=<span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">20</span>];</div><div class="line">        <span class="built_in">sprintf</span>(message_temp,<span class="string">"%s,%d,%d,%d,%d,"</span>,message,sx,sy,dx,dy);</div><div class="line">        <span class="keyword">int</span> len=send_message(message_temp);</div><div class="line">        <span class="keyword">delete</span> message_temp;</div><div class="line">        <span class="keyword">return</span> len;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// CLIENT_H_INCLUDED</span></span></div></pre></td></tr></table></figure>
<ul>
<li>该程序从3.15晚开始，用了四天的空闲时间。</li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://maxuewei2.git.io/2016/03/22/局域网象棋/" data-id="civ09fs69000zeebcmx0jvh3z" class="article-share-link">分享到</a><div class="tags"><a href="/tags/网络编程/">网络编程</a><a href="/tags/小游戏/">小游戏</a></div><div class="post-nav"><a href="/2016/04/12/FlappyBird/" class="pre">Flappy Bird (Java实现)</a><a href="/2016/03/20/socket服务端和客户端/" class="next">Socket服务端和客户端（C++，CodeBlocks+GCC编译）</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://maxuewei2.git.io"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/学习/">学习</a><span class="category-list-count">24</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/">生活</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/C/" style="font-size: 15px;">C++</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/网络编程/" style="font-size: 15px;">网络编程</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/GUI/" style="font-size: 15px;">GUI</a> <a href="/tags/小游戏/" style="font-size: 15px;">小游戏</a> <a href="/tags/记录/" style="font-size: 15px;">记录</a> <a href="/tags/Win32/" style="font-size: 15px;">Win32</a> <a href="/tags/小工具/" style="font-size: 15px;">小工具</a> <a href="/tags/数据结构/" style="font-size: 15px;">数据结构</a> <a href="/tags/网络/" style="font-size: 15px;">网络</a> <a href="/tags/编译/" style="font-size: 15px;">编译</a> <a href="/tags/图形库/" style="font-size: 15px;">图形库</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/10/28/FirstPost/">开始使用GitHub Pages</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/22/近期学到的/">近期学到的</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/12/重定向/">重定向</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/11/CCF记录/">CCF考试</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/13/简单的词法分析和语法分析/">简单的词法分析和语法分析（C++实现，CodeBlocks+GCC编译）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/03/ChatRoom/">聊天室（Java实现）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/08/俄罗斯C++/">俄罗斯方块（Win32实现，Codeblocks+GCC编译）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/08/迷宫/">Java迷宫游戏</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/29/读文件错误/">读文件错误</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/15/findstr/">在文件夹中 的指定类型文件中 查找字符串（CodeBlocks+GCC编译，控制台程序，仅能在Windows上运行）</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">maxuewei2.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>